@startuml Backtest_Process_Sequence

title Backtest Process - Sequence Diagram

actor Trader
participant "BaseBacktestEngine" as Engine
participant "PaperTradingBrokerAPI" as PaperBroker
participant "OrderMatchingEngine" as Matcher
participant "Strategy" as Strategy
participant "PerformanceAnalyzer" as Analyzer
participant "Data Module" as DataModule
participant "Excel Export" as Excel

== Initialization ==

Trader -> Engine: run_backtest(symbol, start, end, timeframe, lot_size)
activate Engine

Engine -> DataModule: load_historical_data(symbol, timeframe, start, end)
activate DataModule
DataModule -> DataModule: Retrieve from cache or MT5
DataModule --> Engine: historical_data[]
deactivate DataModule
note right: Data Module handles MT5 connection\nBacktest Engine doesn't connect directly

Engine -> Engine: df = pd.DataFrame(rates)
Engine -> Engine: df.set_index('time', inplace=True)
note right: CRITICAL FIX\nTime index required\nfor signal detection

Engine -> Strategy: prepare_data(df)
activate Strategy
Strategy -> Strategy: Calculate indicators\n(SMA, ATR, etc.)
Strategy --> Engine: prepared_data
deactivate Strategy

Engine -> PaperBroker: new PaperTradingBrokerAPI(config, balance, mode='backtest')
activate PaperBroker
PaperBroker -> Matcher: new OrderMatchingEngine()
activate Matcher
Matcher --> PaperBroker: matcher_instance
deactivate Matcher
PaperBroker -> PaperBroker: Initialize database (in-memory)
PaperBroker --> Engine: broker_instance
deactivate PaperBroker
note right: Reuses Paper Trading Broker\nSame order matching logic\nSame P&L calculations

Engine -> Analyzer: new PerformanceAnalyzer(balance)
activate Analyzer
Analyzer --> Engine: analyzer_instance
deactivate Analyzer

== Main Trading Loop ==

loop For each bar in historical data
    Engine -> Engine: current_bar = df.iloc[idx].to_dict()
    Engine -> Engine: current_bar['time'] = df.index[idx]
    note right: Add datetime to bar\nfor strategy analysis
    
    Engine -> Strategy: analyze(df, current_bar)
    activate Strategy
    
    Strategy -> Strategy: Check if current_time in df.index
    
    alt Signal Detected
        Strategy -> Strategy: Check entry conditions\n(crossover, pattern, etc.)
        Strategy --> Engine: {'action': 'BUY', 'sl_pips': 50, 'tp_pips': 100}
        
        Engine -> PaperBroker: submit_order(direction, symbol, lot_size, sl_pips, tp_pips)
        activate PaperBroker
        
        PaperBroker -> Matcher: match_order(order, current_bar)
        activate Matcher
        
        Matcher -> Matcher: random_rejection_check(5%)
        
        alt Order Accepted (95%)
            Matcher -> Matcher: entry_price = close + spread
            Matcher -> Matcher: slippage = random(0, 2 pips)
            Matcher -> Matcher: commission = 7 * lot_size
            
            Matcher -> Matcher: Create fill record
            Matcher --> PaperBroker: order_filled
            
            PaperBroker -> PaperBroker: Create position in database
            PaperBroker -> PaperBroker: Update balance
            PaperBroker --> Engine: order_executed
            note right: Order ID: ORD_000001\nEntry: 1.1000\nSL: 1.0950\nTP: 1.1100\nShared logic with Paper Trading
            
        else Order Rejected (5%)
            Matcher -> Matcher: Log rejection reason
            Matcher --> PaperBroker: order_rejected
            PaperBroker --> Engine: rejection_notice
            note right: Rejection reasons:\n- Broker error\n- Low liquidity\n- Max slippage
        end
        
        deactivate Matcher
        deactivate PaperBroker
        
    else No Signal
        Strategy --> Engine: None
    end
    
    deactivate Strategy
    
    == Position Management ==
    
    Engine -> PaperBroker: process_market_data(current_bar)
    activate PaperBroker
    
    PaperBroker -> PaperBroker: get_open_positions()
    
    loop For each open position
        PaperBroker -> PaperBroker: Check if SL hit\n(low <= stop_loss)
        
        alt Stop Loss Hit
            PaperBroker -> PaperBroker: exit_price = stop_loss + sl_slippage
            PaperBroker -> PaperBroker: Calculate P&L\npnl = (exit - entry) * lot_size * pip_value
            PaperBroker -> PaperBroker: net_pnl = pnl - costs
            
            PaperBroker -> PaperBroker: close_position(position_id, 'Stop Loss')
            PaperBroker -> PaperBroker: Save trade to database
            PaperBroker -> PaperBroker: Update balance
            
            note right: Position auto-closed\nReason: Stop Loss\nNet P&L: -$95.18\n(Fully tested: 49/49 tests)
            
        else Check Take Profit
            PaperBroker -> PaperBroker: Check if TP hit\n(high >= take_profit)
            
            alt Take Profit Hit
                PaperBroker -> PaperBroker: exit_price = take_profit - tp_slippage
                PaperBroker -> PaperBroker: Calculate P&L
                PaperBroker -> PaperBroker: close_position(position_id, 'Take Profit')
                PaperBroker -> PaperBroker: Save trade to database
                PaperBroker -> PaperBroker: Update balance
                
                note right: Position auto-closed\nReason: Take Profit\nNet P&L: +$163.70
                
            else Position Remains Open
                PaperBroker -> PaperBroker: Update floating P&L
            end
        end
    end
    
    PaperBroker --> Engine: positions_updated
    deactivate PaperBroker
    
end

== Finalization ==

Engine -> PaperBroker: stop_session()
activate PaperBroker
PaperBroker -> PaperBroker: Close all open positions
PaperBroker -> PaperBroker: Finalize trades in database
PaperBroker --> Engine: session_stopped
deactivate PaperBroker

Engine -> PaperBroker: get_closed_trades()
activate PaperBroker
PaperBroker -> PaperBroker: Query trades from database
PaperBroker --> Engine: trades[]
deactivate PaperBroker
note right: Trades stored in database\nSame format as Paper Trading\nEasy to compare results

Engine -> Analyzer: add_trades(trades)
activate Analyzer
Analyzer -> Analyzer: Calculate metrics
note right: Metrics calculated:\n- Win rate: 41.2%\n- Profit factor: 0.84\n- Sharpe ratio: -1.363\n- Max drawdown: 68.13%\n- Total return: -65.20%

Analyzer --> Engine: metrics{}
deactivate Analyzer

Engine -> Excel: create_excel_report(trades, metrics, symbol)
activate Excel

Excel -> Excel: Create Workbook
Excel -> Excel: Create "Trades" sheet
Excel -> Excel: Add trade data
Excel -> Excel: Format columns
Excel -> Excel: Create "Performance Metrics" sheet
Excel -> Excel: Add metrics data
Excel -> Excel: Create "Monthly Returns" sheet
Excel -> Excel: Calculate monthly breakdown

Excel -> Excel: Save to reports/backtest_{symbol}_{timestamp}.xlsx
Excel --> Engine: report_saved
deactivate Excel

Engine --> Trader: metrics, report_path

note over Trader: Trader reviews:\n- Excel report\n- Dashboard\n- Performance charts

deactivate Engine

@enduml
